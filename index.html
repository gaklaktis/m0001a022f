<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–π—Ç–∏–Ω–≥ –ú–∞—Ñ–∏–∏</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind CDN (–±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* –ù–µ–±–æ–ª—å—à–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ */
    .table-scroll {
      -webkit-overflow-scrolling: touch;
    }
    /* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
    .fade-in { animation: fadeIn .22s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: none; } }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

  <div class="max-w-5xl mx-auto p-4">
    <!-- Header -->
    <header class="bg-white rounded-2xl shadow-md p-4 mb-4 flex items-center justify-between gap-4">
      <div>
        <h1 class="text-xl font-semibold">üèÜ –†–µ–π—Ç–∏–Ω–≥ –ú–∞—Ñ–∏–∏</h1>
        <p id="mode-label" class="text-sm text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</p>
      </div>

      <div class="flex items-center gap-3">
        <button id="refresh-btn" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-md text-sm">‚ü≥ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <div id="badge" class="text-sm text-slate-500"></div>
      </div>
    </header>

    <!-- Main card -->
    <main class="bg-white rounded-2xl shadow p-4 fade-in">
      <!-- loading / error -->
      <div id="loading" class="text-center py-8 text-slate-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
      <div id="error" class="hidden text-center py-4 bg-red-50 text-red-700 rounded-md mb-4"></div>

      <div class="overflow-x-auto table-scroll rounded-md">
        <table id="rating-table" class="min-w-[900px] w-full text-sm table-auto hidden">
          <thead class="bg-slate-800 text-white sticky top-0">
            <tr>
              <th class="p-3 text-left">–ú–µ—Å—Ç–æ</th>
              <th class="p-3 text-left">–ù–∏–∫</th>
              <th class="p-3 text-center">–ò–≥—Ä—ã</th>
              <th class="p-3 text-center">–ú–∏—Ä–Ω—ã–π</th>
              <th class="p-3 text-center">–ú–∞—Ñ–∏—è</th>
              <th class="p-3 text-center">–î–æ–Ω</th>
              <th class="p-3 text-center">–õ—é–±–æ–≤–Ω–∏—Ü–∞</th>
              <th class="p-3 text-center">–®–µ—Ä–∏—Ñ</th>
              <th class="p-3 text-center">–î–æ–∫—Ç–æ—Ä</th>
              <th class="p-3 text-center">–ú–∞–Ω—å—è–∫</th>
              <th class="p-3 text-center">–ö–∞–º–∏–∫–∞–¥–∑–µ</th>
              <th class="p-3 text-center">–ú—Å—Ç–∏—Ç–µ–ª—å</th>
              <th class="p-3 text-center">–û—á–∫–∏</th>
            </tr>
          </thead>
          <tbody id="table-body" class="bg-white"></tbody>
        </table>
      </div>

      <!-- actions -->
      <div class="mt-4 flex gap-3 items-center justify-between">
        <div>
          <button id="add-row-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>

        <div class="flex gap-2">
          <button id="save-btn" class="hidden px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
          <button id="cancel-btn" class="hidden px-4 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </main>

    <!-- Footer small note -->
    <footer class="text-xs text-slate-400 mt-3 text-center">
      –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ <code>data.json</code> –Ω–∞ GitHub Pages.
    </footer>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40 px-4">
    <div class="w-full max-w-md bg-white rounded-xl p-4 shadow">
      <h3 id="modal-title" class="font-medium mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
      <input id="modal-input" class="w-full border rounded px-3 py-2 mb-3" type="text" />
      <div class="flex gap-3 justify-end">
        <button id="modal-cancel" class="px-4 py-2 rounded bg-red-50 text-red-700">–û—Ç–º–µ–Ω–∞</button>
        <button id="modal-ok" class="px-4 py-2 rounded bg-blue-600 text-white">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      tg.expand?.();
      try { tg.enableClosingConfirmation?.(); } catch(e) {}
    }

    // State
    let players = [];
    let mode = 'view'; // 'view' | 'edit'
    let hasChanges = false;
    let currentEdit = null; // { type: 'nick'|'role'|'place', idx, role }
    const ROLES = ['–º–∏—Ä–Ω—ã–π','–º–∞—Ñ–∏—è','–¥–æ–Ω','–ª—é–±–æ–≤–Ω–∏—Ü–∞','—à–µ—Ä–∏—Ñ','–¥–æ–∫—Ç–æ—Ä','–º–∞–Ω—å—è–∫','–∫–∞–º–∏–∫–∞–¥–∑–µ','–º—Å—Ç–∏—Ç–µ–ª—å'];

    // Elements
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const tableEl = document.getElementById('rating-table');
    const tbody = document.getElementById('table-body');
    const modeLabel = document.getElementById('mode-label');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const addRowBtn = document.getElementById('add-row-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const badge = document.getElementById('badge');

    // Modal
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalInput = document.getElementById('modal-input');
    const modalOk = document.getElementById('modal-ok');
    const modalCancel = document.getElementById('modal-cancel');

    // Helpers
    function qparam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
      loadingEl.classList.add('hidden');
      tableEl.classList.add('hidden');
    }

    function hideError() {
      errorEl.classList.add('hidden');
    }

    function setMode(m) {
      mode = m;
      const isEdit = mode === 'edit';
      modeLabel.textContent = isEdit ? '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è' : '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
      modeLabel.className = isEdit ? 'text-sm text-amber-600' : 'text-sm text-slate-500';

      // show/hide controls
      if (isEdit) {
        saveBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
        addRowBtn.classList.remove('hidden');
      } else {
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
        addRowBtn.classList.add('hidden');
      }
    }

    function formatRoleCell(roleData) {
      const o = roleData?.o ?? 0;
      const t = roleData?.t ?? 0;
      return `${o}/${t}`;
    }

    // load data.json from the same origin (GitHub Pages)
    async function loadData() {
      try {
        hideError();
        loadingEl.classList.remove('hidden');
        tableEl.classList.add('hidden');

        // fetch data.json (no absolute URL) ‚Äî works on GitHub Pages
        const res = await fetch('data.json', { cache: "no-store" });
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + res.status);
        const data = await res.json();
        players = Array.isArray(data) ? data : [];
        renderTable();
      } catch (err) {
        console.error(err);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ data.json. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        players = [];
        renderTable(); // still render empty state
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    function renderTable() {
      tbody.innerHTML = '';
      if (!players || players.length === 0) {
        const r = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 13;
        td.className = 'text-center py-6 text-slate-500';
        td.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
        r.appendChild(td);
        tbody.appendChild(r);
        tableEl.classList.remove('hidden');
        badge.textContent = '';
        return;
      }

      players.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.className = idx % 2 === 0 ? '' : 'bg-slate-50';

        // place
        const tdPlace = document.createElement('td');
        tdPlace.className = 'p-3';
        tdPlace.textContent = p.place ?? '';
        if (mode === 'edit') {
          tdPlace.classList.add('cursor-pointer', 'text-slate-700', 'hover:bg-slate-100');
          tdPlace.onclick = () => openModal('place', idx, String(p.place ?? ''));
        }
        tr.appendChild(tdPlace);

        // nick
        const tdNick = document.createElement('td');
        tdNick.className = 'p-3';
        tdNick.textContent = p.nick ?? '';
        if (mode === 'edit') {
          tdNick.classList.add('cursor-pointer', 'hover:bg-slate-100');
          tdNick.onclick = () => openModal('nick', idx, p.nick ?? '');
        }
        tr.appendChild(tdNick);

        // games
        const tdGames = document.createElement('td');
        tdGames.className = 'p-3 text-center';
        tdGames.textContent = p.totalGames ?? 0;
        tr.appendChild(tdGames);

        // roles
        ROLES.forEach(role => {
          const tdRole = document.createElement('td');
          tdRole.className = 'p-3 text-center';
          const roleData = p[role] ?? { o: 0, t: 0 };
          tdRole.textContent = formatRoleCell(roleData);
          if (mode === 'edit') {
            tdRole.classList.add('cursor-pointer', 'hover:bg-slate-100');
            tdRole.onclick = () => openModal('role', idx, `${roleData.o}`, role);
          }
          tr.appendChild(tdRole);
        });

        // points
        const tdPoints = document.createElement('td');
        tdPoints.className = 'p-3 text-center font-medium';
        tdPoints.textContent = p.totalPoints ?? 0;
        tr.appendChild(tdPoints);

        tbody.appendChild(tr);
      });

      tableEl.classList.remove('hidden');
      badge.textContent = `${players.length} –∏–≥—Ä–æ–∫(–æ–≤)`;
    }

    function openModal(type, idx, value = '', role = null) {
      currentEdit = { type, idx, role };
      modalTitle.textContent = type === 'nick' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏–∫–∞' : (type === 'place' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞' : `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${role}`);
      modalInput.value = value ?? '';
      modal.classList.remove('hidden');
      modalInput.focus();
    }

    function closeModal() {
      modal.classList.add('hidden');
      currentEdit = null;
      modalInput.value = '';
    }

    function applyModal() {
      if (!currentEdit) return;
      const v = modalInput.value.trim();
      const idx = currentEdit.idx;
      const p = players[idx] || {};
      if (currentEdit.type === 'nick') {
        p.nick = v || p.nick || '–ò–≥—Ä–æ–∫';
      } else if (currentEdit.type === 'place') {
        p.place = v || p.place || '';
      } else if (currentEdit.type === 'role') {
        const role = currentEdit.role;
        const points = parseInt(v);
        if (!Number.isNaN(points)) {
          p[role] = p[role] || { o: 0, t: 0 };
          // –∑–¥–µ—Å—å –ª–æ–≥–∏–∫–∞: –¥–æ–±–∞–≤–ª—è–µ–º points –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º t –Ω–∞ 1
          p[role].o = (p[role].o || 0) + points;
          p[role].t = (p[role].t || 0) + 1;
        } else {
          // –µ—Å–ª–∏ –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–µ —á–∏—Å–ª–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        }
      }
      // recalc
      recalcPlayer(idx);
      hasChanges = true;
      renderTable();
      closeModal();
    }

    function recalcPlayer(idx) {
      const p = players[idx];
      if (!p) return;
      let totalPoints = 0, totalGames = 0;
      ROLES.forEach(r => {
        const d = p[r] || {o:0,t:0};
        totalPoints += (d.o || 0);
        totalGames += (d.t || 0);
      });
      p.totalPoints = totalPoints;
      p.totalGames = totalGames;
    }

    // actions
    addRowBtn.addEventListener('click', () => {
      const newPlayer = { place: '', nick: '–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫', totalGames: 0, totalPoints: 0 };
      ROLES.forEach(r => newPlayer[r] = { o: 0, t: 0 });
      players.push(newPlayer);
      hasChanges = true;
      renderTable();
    });

    saveBtn.addEventListener('click', () => {
      if (!hasChanges) {
        // –Ω–µ–±–æ–ª—å—à–∞—è –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        if (tg) tg.showPopup?.({ title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', message: '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', buttons: [{type:'ok'}] });
        return;
      }

      // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (tg) {
        tg.showPopup?.({
          title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',
          message: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–æ—Ç–∞?',
          buttons: [{ id: 'yes', type: 'default', text: '–î–∞' }, { type: 'cancel' }]
        }, (btnId) => {
          if (btnId === 'yes') doSend();
        });
      } else {
        if (confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?')) doSend();
      }
    });

    cancelBtn.addEventListener('click', () => {
      // –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
      loadData();
      hasChanges = false;
    });

    function doSend() {
      try {
        // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º players –≤ –±–æ—Ç–∞
        const payload = JSON.stringify(players);
        if (tg && typeof tg.sendData === 'function') {
          tg.sendData(payload);
          // UI feedback
          saveBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úì';
          saveBtn.classList.add('opacity-80');
          setTimeout(() => {
            saveBtn.textContent = 'üíæ –°–û–•–†–ê–ù–ò–¢–¨';
          }, 1500);
          hasChanges = false;
        } else {
          // fallback
          alert('tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram.');
        }
      } catch (err) {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + err.message);
      }
    }

    // modal listeners
    modalOk.addEventListener('click', applyModal);
    modalCancel.addEventListener('click', closeModal);
    modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyModal(); if (e.key === 'Escape') closeModal(); });

    // refresh
    refreshBtn.addEventListener('click', loadData);

    // init
    (function init() {
      // determine mode from URL: use ?mode=edit to allow edits (bot opens only for admin with this param)
      const q = qparam('mode');
      setMode(q === 'edit' ? 'edit' : 'view');

      // load data.json
      loadData();
    })();

    // Accessibility: close modal on backdrop click
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  </script>
</body>
</html>
