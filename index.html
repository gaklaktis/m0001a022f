<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Рейтинг Мафии</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 10px; min-height: 100vh; }
        .container { max-width: 100%; transform-origin: top left; transition: transform 0.15s; }
        .header { text-align: center; padding: 16px; background: white; border-radius: 14px; margin-bottom: 16px; box-shadow: 0 3px 12px rgba(0,0,0,0.1); }
        .header h2 { font-size: 22px; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; margin: 20px auto; max-width: 400px; width: 100%; }
        .save-btn, .refresh-btn { padding: 15px; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; color: white; cursor: pointer; }
        .save-btn { background: #4caf50; }
        .refresh-btn { background: #2196F3; }
        .loading { text-align: center; padding: 30px; color: #666; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 14px; overflow: hidden; font-size: 13px; }
        th, td { padding: 10px 6px; text-align: center; border: 1px solid #e0e0e0; min-width: 44px; }
        th { background: #1976d2; color: white; position: sticky; top: 0; }
        .points-cell { background: #ff5252 !important; color: white; font-weight: bold; }
        .editable { cursor: pointer; }
        .editable:hover { background: #bbdefb !important; }
        .add-row { background: #4caf50 !important; color: white; }
    </style>
</head>
<body>

<div class="header">
    <h2>Рейтинг Мафии</h2>
    <p id="status">Загрузка данных...</p>
</div>

<div id="loading" class="loading">Попытка загрузить данные...</div>
<table id="table" style="display:none;">
    <thead>
        <tr>
            <th>Место</th><th>Ник</th><th>Игры</th>
            <th>Мирный</th><th>Мафия</th><th>Дон</th><th>Любовница</th>
            <th>Шериф</th><th>Доктор</th><th>Маньяк</th><th>Камикадзе</th><th>Мститель</th>
            <th>Очки</th>
        </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<div class="btn-group">
    <button id="save-btn" class="save-btn" style="display:none;">СОХРАНИТЬ</button>
    <button id="refresh-btn" class="refresh-btn">ОБНОВИТЬ ДАННЫЕ</button>
</div>

<script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand();

    let players = [];
    let isEditMode = false;
    let hasChanges = false;

    // Безопасный alert (работает везде)
    function safeAlert(msg) {
        try {
            if (tg && tg.showAlert) tg.showAlert(msg);
            else alert(msg);
        } catch (e) {
            console.warn("showAlert не поддерживается:", e);
            alert(msg);
        }
    }

    function loadData() {
        const params = new URLSearchParams(location.search);
        let url = params.get('dataUrl');
        if (!url) return safeAlert("Нет ссылки на данные");

        try { url = decodeURIComponent(url); } catch(e) {}

        isEditMode = params.get('edit') === 'true';

        const base = url.split('?')[0];
        const bust = Date.now();

        // Пробуем 3 реальных пути (у тебя файл в Public!)
        const urls = [
            `${base}?t=${bust}`,
            base.replace('/main/', '/main/Public/') + `?t=${bust}`,
            base.replace('raw.githubusercontent.com', 'cdn.statically.io/gh') + `?t=${bust}`
        ];

        document.getElementById('loading').textContent = 'Попытка 1/3...';

        let index = 0;
        function tryLoad() {
            if (index >= urls.length) {
                document.getElementById('status').textContent = 'Ошибка загрузки';
                document.getElementById('loading').textContent = 'Не удалось загрузить data.json';
                console.error("Все пути не сработали:", urls);
                return;
            }

            console.log("Пробуем:", urls[index]);
            document.getElementById('loading').textContent = `Попытка ${index + 1}/3...`;

            fetch(urls[index], { cache: "no-store" })
                .then(r => {
                    if (!r.ok) throw new Error(r.status);
                    return r.json();
                })
                .then(data => {
                    players = Array.isArray(data) ? data : [];
                    render();
                    document.getElementById('status').textContent = `Загружено: ${players.length} игроков`;
                    console.log("Успешно загружено из:", urls[index]);
                })
                .catch(err => {
                    console.warn("Не сработало:", urls[index], err);
                    index++;
                    setTimeout(tryLoad, 500);
                });
        }

        tryLoad();
    }

    function render() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table').style.display = 'table';
        document.getElementById('save-btn').style.display = isEditMode ? 'block' : 'none';

        if (players.length === 0) {
            const tr = tbody.insertRow();
            const td = tr.insertCell();
            td.colSpan = 13;
            td.textContent = 'Нет данных';
            td.style.textAlign = 'center';
            td.style.padding = '40px';
            td.style.color = '#999';
            return;
        }

        players.forEach((p, i) => {
            const tr = tbody.insertRow();

            const placeTd = tr.insertCell();
            placeTd.textContent = p.place || '';
            if (isEditMode) {
                placeTd.className = 'editable add-row';
                placeTd.onclick = () => addPlayer(i);
            }

            const nickTd = tr.insertCell();
            nickTd.textContent = p.nick || '—';
            if (isEditMode) { nickTd.className = 'editable'; nickTd.onclick = () => editNick(i); }

            tr.insertCell().textContent = p.totalGames || 0;

            ['мирный','мафия','дон','любовница','шериф','доктор','маньяк','камикадзе','мститель'].forEach(role => {
                const td = tr.insertCell();
                const d = p[role] || {o:0,t:0};
                td.textContent = `${d.o||0}/${d.t||0}`;
                if (isEditMode) {
                    td.className = 'editable';
                    td.onclick = () => editRole(i, role);
                }
            });

            const pts = tr.insertCell();
            pts.textContent = p.totalPoints || 0;
            pts.className = 'points-cell';
        });
    }

    function addPlayer(i) {
        players.splice(i + 1, 0, {nick: "Новый игрок", totalGames: 0, totalPoints: 0,
            мирный:{o:0,t:0}, мафия:{o:0,t:0}, дон:{o:0,t:0}, любовница:{o:0,t:0},
            шериф:{o:0,t:0}, доктор:{o:0,t:0}, маньяк:{o:0,t:0}, камикадзе:{o:0,t:0}, мститель:{o:0,t:0}
        });
        hasChanges = true;
        render();
    }

    function editNick(i) {
        const nick = prompt("Новый ник:", players[i].nick || "");
        if (nick !== null) {
            players[i].nick = nick || "Игрок";
            hasChanges = true;
            render();
        }
    }

    function editRole(i, role) {
        const val = prompt(`Роль: ${role}\n\n0–4 — добавить очки\n00 — откат\n000N — заменить`, "");
        if (val === null) return;

        const data = players[i][role] || {o:0,t:0};
        if (val === "00" && data.lastPoints !== undefined) {
            data.o = Math.max(0, data.o - data.lastPoints);
            data.t = Math.max(0, data.t - 1);
            delete data.lastPoints;
        } else if (val.startsWith("000")) {
            const n = parseInt(val.slice(3));
            if (!isNaN(n)) data.o = n;
        } else {
            const pts = parseInt(val);
            if (isNaN(pts) || pts < 0 || pts > 4) return safeAlert("Только 0–4!");
            data.lastPoints = pts;
            data.o = (data.o || 0) + pts;
            data.t = (data.t || 0) + 1;
        }
        players[i][role] = data;
        // Пересчитываем очки
        let total = 0, games = 0;
        for (const r of ['мирный','мафия','дон','любовница','шериф','доктор','маньяк','камикадзе','мститель']) {
            const d = players[i][r] || {o:0,t:0};
            total += d.o || 0;
            games += d.t || 0;
        }
        players[i].totalPoints = total;
        players[i].totalGames = games;
        hasChanges = true;
        render();
    }

    document.getElementById('save-btn').onclick = () => {
        if (!hasChanges) return safeAlert("Нет изменений");
        if (!tg || !tg.sendData) return safeAlert("sendData недоступен");
        tg.sendData(JSON.stringify(players));
        hasChanges = false;
        setTimeout(() => loadData(), 2000);
    };

    document.getElementById('refresh-btn').onclick = () => loadData();

    // Старт
    loadData();
</script>
</body>
</html>
