<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–π—Ç–∏–Ω–≥ –ú–∞—Ñ–∏–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            overflow-x: auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        th, td {
            padding: 6px 3px;
            text-align: center;
            border: 1px solid #e0e0e0;
            min-width: 40px;
        }
        
        th {
            background: #2196F3;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .editable:hover {
            background-color: #e3f2fd !important;
        }
        
        .add-row {
            background: #4CAF50 !important;
            color: white;
        }
        
        .save-btn {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-btn:hover {
            background: #45a049;
        }
        
        .save-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .save-btn.saved {
            background: #2E7D32;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
        }
        
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .confirm-btn {
            background: #4CAF50;
            color: white;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üèÜ –†–µ–π—Ç–∏–Ω–≥ –ú–∞—Ñ–∏–∏ üèÜ</h2>
            <p id="edit-mode" style="color: #666; margin-top: 5px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <table id="rating-table" style="display: none;">
            <thead>
                <tr>
                    <th>–ú–µ—Å—Ç–æ</th>
                    <th>–ù–∏–∫</th>
                    <th>–ò–≥—Ä—ã</th>
                    <th>–ú–∏—Ä–Ω—ã–π</th>
                    <th>–ú–∞—Ñ–∏—è</th>
                    <th>–î–æ–Ω</th>
                    <th>–õ—é–±–æ–≤–Ω–∏—Ü–∞</th>
                    <th>–®–µ—Ä–∏—Ñ</th>
                    <th>–î–æ–∫—Ç–æ—Ä</th>
                    <th>–ú–∞–Ω—å—è–∫</th>
                    <th>–ö–∞–º–∏–∫–∞–¥–∑–µ</th>
                    <th>–ú—Å—Ç–∏—Ç–µ–ª—å</th>
                    <th>–û—á–∫–∏</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JavaScript -->
            </tbody>
        </table>
        
        <button id="save-btn" class="save-btn" style="display: none;">
            üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø
        </button>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="text" id="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn confirm-btn" onclick="confirmEdit()">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        let tg = Telegram.WebApp;
        let players = [];
        let isEditMode = false;
        let isAdmin = false;
        let currentEdit = null;
        let hasChanges = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                data: urlParams.get('data'),
                isAdmin: urlParams.get('isAdmin') === 'true',
                edit: urlParams.get('edit') === 'true'
            };
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
        function loadDataFromUrl() {
			const params = new URLSearchParams(window.location.search);
			const dataUrl = params.get('dataUrl');
			isAdmin = params.get('isAdmin') === 'true';
			isEditMode = params.get('edit') === 'true' && isAdmin;
            
			if (dataUrl) {
				// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ GitHub
				fetch(dataUrl)
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.json();
					})
					.then(data => {
						players = data;
						renderTable();
					})
					.catch(error => {
						console.error('Error loading data from GitHub:', error);
						document.getElementById('loading').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ GitHub';
					});
			} else {
				document.getElementById('loading').innerHTML = 'URL –¥–∞–Ω–Ω—ã—Ö –Ω–µ —É–∫–∞–∑–∞–Ω';
			}
		}
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const tbody = document.getElementById('table-body');
            const loading = document.getElementById('loading');
            const table = document.getElementById('rating-table');
            const saveBtn = document.getElementById('save-btn');
            const editModeText = document.getElementById('edit-mode');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            loading.style.display = 'none';
            table.style.display = 'table';
            
            tbody.innerHTML = '';
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // –ú–µ—Å—Ç–æ
                const placeCell = document.createElement('td');
                placeCell.textContent = player.place || '';
                if (isEditMode) {
                    placeCell.classList.add('editable', 'add-row');
                    placeCell.onclick = () => editPlace(index);
                }
                row.appendChild(placeCell);
                
                // –ù–∏–∫
                const nickCell = document.createElement('td');
                nickCell.textContent = player.nick || '';
                if (isEditMode) {
                    nickCell.classList.add('editable');
                    nickCell.onclick = () => editNick(index);
                }
                row.appendChild(nickCell);
                
                // –ö–æ–ª. –∏–≥—Ä
                const gamesCell = document.createElement('td');
                gamesCell.textContent = player.totalGames || 0;
                row.appendChild(gamesCell);
                
                // –†–æ–ª–∏
                const roles = ['–º–∏—Ä–Ω—ã–π', '–º–∞—Ñ–∏—è', '–¥–æ–Ω', '–ª—é–±–æ–≤–Ω–∏—Ü–∞', '—à–µ—Ä–∏—Ñ', '–¥–æ–∫—Ç–æ—Ä', '–º–∞–Ω—å—è–∫', '–∫–∞–º–∏–∫–∞–¥–∑–µ', '–º—Å—Ç–∏—Ç–µ–ª—å'];
                roles.forEach(role => {
                    const roleCell = document.createElement('td');
                    const roleData = player[role] || {o: 0, t: 0};
                    roleCell.textContent = `${roleData.o}/${roleData.t}`;
                    if (isEditMode) {
                        roleCell.classList.add('editable');
                        roleCell.onclick = () => editRole(index, role);
                    }
                    row.appendChild(roleCell);
                });
                
                // –û—á–∫–∏
                const pointsCell = document.createElement('td');
                pointsCell.textContent = player.totalPoints || 0;
                row.appendChild(pointsCell);
                
                tbody.appendChild(row);
            });
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if (isEditMode) {
                saveBtn.style.display = 'block';
                editModeText.textContent = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                editModeText.style.color = '#ff9800';
            } else {
                saveBtn.style.display = 'none';
                editModeText.textContent = '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä';
                editModeText.style.color = '#666';
            }
            
            if (!isAdmin) {
                editModeText.textContent = '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–µ –∞–¥–º–∏–Ω)';
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏)
        function editPlace(index) {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π
            const newPlayer = {
                place: '',
                nick: '–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫',
                totalGames: 0,
                totalPoints: 0,
                –º–∏—Ä–Ω—ã–π: {o: 0, t: 0},
                –º–∞—Ñ–∏—è: {o: 0, t: 0},
                –¥–æ–Ω: {o: 0, t: 0},
                –ª—é–±–æ–≤–Ω–∏—Ü–∞: {o: 0, t: 0},
                —à–µ—Ä–∏—Ñ: {o: 0, t: 0},
                –¥–æ–∫—Ç–æ—Ä: {o: 0, t: 0},
                –º–∞–Ω—å—è–∫: {o: 0, t: 0},
                –∫–∞–º–∏–∫–∞–¥–∑–µ: {o: 0, t: 0},
                –º—Å—Ç–∏—Ç–µ–ª—å: {o: 0, t: 0}
            };
            
            players.splice(index + 1, 0, newPlayer);
            hasChanges = true;
            renderTable();
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏–∫–∞
        function editNick(index) {
            currentEdit = { type: 'nick', index: index };
            showModal('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏–∫–∞', players[index].nick || '');
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
        function editRole(index, role) {
            currentEdit = { type: 'role', index: index, role: role };
            showModal(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${role} (o/t)`, '');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showModal(title, value) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-input').value = value;
            document.getElementById('edit-modal').style.display = 'flex';
            document.getElementById('modal-input').focus();
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEdit = null;
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function confirmEdit() {
            const value = document.getElementById('modal-input').value.trim();
            
            if (currentEdit) {
                if (currentEdit.type === 'nick') {
                    players[currentEdit.index].nick = value;
                } else if (currentEdit.type === 'role') {
                    // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ä–æ–ª–µ–π
                    const roleData = players[currentEdit.index][currentEdit.role] || {o: 0, t: 0};
                    
                    if (value === '123') {
                        // –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–µ–¥–µ–Ω–∏—è
                        roleData.o = Math.max(0, roleData.o - (roleData.lastPoints || 0));
                        roleData.t = Math.max(0, roleData.t - 1);
                    } else {
                        const points = parseInt(value);
                        if (!isNaN(points)) {
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
                            roleData.lastPoints = points;
                            roleData.o = points;
                            roleData.t += 1;
                        }
                    }
                    
                    players[currentEdit.index][currentEdit.role] = roleData;
                }
                
                // –ü–µ—Ä–µ—Å—á–µ—Ç –æ–±—â–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
                recalculatePlayer(currentEdit.index);
                hasChanges = true;
            }
            
            closeModal();
            renderTable();
        }
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç –∏–≥—Ä–æ–∫–∞
        function recalculatePlayer(index) {
            const player = players[index];
            let totalGames = 0;
            let totalPoints = 0;
            
            const roles = ['–º–∏—Ä–Ω—ã–π', '–º–∞—Ñ–∏—è', '–¥–æ–Ω', '–ª—é–±–æ–≤–Ω–∏—Ü–∞', '—à–µ—Ä–∏—Ñ', '–¥–æ–∫—Ç–æ—Ä', '–º–∞–Ω—å—è–∫', '–∫–∞–º–∏–∫–∞–¥–∑–µ', '–º—Å—Ç–∏—Ç–µ–ª—å'];
            roles.forEach(role => {
                const roleData = player[role] || {o: 0, t: 0};
                totalGames += roleData.t;
                totalPoints += roleData.o;
            });
            
            player.totalGames = totalGames;
            player.totalPoints = totalPoints;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('save-btn').onclick = function() {
            if (!hasChanges) {
                tg.showPopup({
                    title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',
                    message: '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è',
                    buttons: [{type: 'ok'}]
                });
                return;
            }
            
            tg.showPopup({
                title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',
                message: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è?',
                buttons: [
                    {id: 'yes', type: 'default', text: '–î–∞'},
                    {type: 'cancel'}
                ]
            }, function(btnId) {
                if (btnId === 'yes') {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
                    const saveBtn = document.getElementById('save-btn');
                    saveBtn.textContent = 'üíæ –°–û–•–†–ê–ù–Ø–ï–ú...';
                    saveBtn.disabled = true;
                    
                    tg.sendData(JSON.stringify(players));
                    
                    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –∑–µ–ª–µ–Ω—É—é
                    setTimeout(() => {
                        saveBtn.textContent = '‚úÖ –°–û–•–†–ê–ù–ï–ù–û';
                        saveBtn.classList.add('saved');
                        hasChanges = false;
                    }, 1000);
                }
            });
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadDataFromUrl();
    </script>
</body>
</html>
